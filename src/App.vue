<template>
  <div id="app">
    <h2>State: {{ connectionState }}</h2>
    <h4>Message: {{ lastMessage }}</h4>
    <div id="wrapper">
      <div id="chart"></div>

      <div id="tableWrapper">
        <table id="ratesTable">
          <thead>
            <tr>
              <th>Currency</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>USD</td>
              <td>{{ latestUSDValue }}</td>
            </tr>
            <tr>
              <td>EUR</td>
              <td>{{ latestEURValue }}</td>
            </tr>
            <tr>
              <td>ETH</td>
              <td>{{ latestETHValue }}</td>
            </tr>
            <tr>
              <td>BTC</td>
              <td>{{ latestBTCValue }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<script>
/* global Highcharts */
export default {
  name: "App",
  mounted: function() {
    this.connectToSocket();
  },
  data: () => {
    return {
      connectionState: "Component initialized.",
      lastMessage: "",
      ethUsd: [],
      btcUsd: [],
      btcEur: [],
      latestUSDValue: 0,
      latestEURValue: 0,
      latestETHValue: 0,
      latestBTCValue: 0,
      chart: null
    };
  },
  methods: {
    connectToSocket() {
      const wsUrl = "wss://ws.bitstamp.net.";
      this.connectionState = `Connecting to bitstamp... (${wsUrl})`;
      const mySocket = new WebSocket(wsUrl);
      this.connectionState = "Connected to bitstamp...";

      mySocket.addEventListener("open", () => {
        this.drawChart();

        mySocket.send(
          JSON.stringify({
            event: "bts:subscribe",
            data: {
              channel: "live_trades_ethusd"
            }
          })
        );
        mySocket.send(
          JSON.stringify({
            event: "bts:subscribe",
            data: {
              channel: "live_trades_btcusd"
            }
          })
        );
        mySocket.send(
          JSON.stringify({
            event: "bts:subscribe",
            data: {
              channel: "live_trades_btceur"
            }
          })
        );
      });

      // Listen for messages
      mySocket.addEventListener("message", event => {
        console.log("Message from server ", event.data);
        const data = JSON.parse(event.data);
        console.log("Message from server ", data.data.timestamp);
        switch (data.channel) {
          case "live_trades_btcusd":
            this.btcUsd.push([data.data.timestamp, data.data.price]);
            // this.chart.series[0].data = this.btcUsd;
            // this.chart.redraw();
            break;
          case "live_trades_ethusd":
            this.ethUsd.push([data.data.timestamp, data.data.price]);
            // this.chart.series[0].data = this.btcUsd;
            // this.chart.redraw();
            break;
          case "live_trades_btceur":
            this.btcEur.push([data.data.timestamp, data.data.price]);
            // this.chart.series[0].data = this.btcUsd;
            // this.chart.redraw();
            break;
        }
        this.drawChart();
        this.lastMessage = event.data;
      });
    },
    drawChart() {
      this.chart = Highcharts.chart("chart", {
        chart: {
          zoomType: "x"
        },
        title: {
          text: "BTC to USD to EUR to ETH exchange rate over time"
        },
        subtitle: {
          text:
            document.ontouchstart === undefined
              ? "Click and drag in the plot area to zoom in"
              : "Pinch the chart to zoom in"
        },
        xAxis: {
          type: "datetime"
        },
        yAxis: {
          title: {
            text: "Exchange rates"
          }
        },
        legend: {
          enabled: true
        },
        plotOptions: {
          area: {
            fillColor: {
              linearGradient: {
                x1: 0,
                y1: 0,
                x2: 0,
                y2: 1
              },
              stops: [
                [0, Highcharts.getOptions().colors[0]],
                [
                  1,
                  Highcharts.color(Highcharts.getOptions().colors[0])
                    .setOpacity(0)
                    .get("rgba")
                ]
              ]
            },
            marker: {
              radius: 2
            },
            lineWidth: 1,
            states: {
              hover: {
                lineWidth: 1
              }
            },
            threshold: null
          }
        },

        series: [
          {
            type: "area",
            name: "ETH to USD",
            data: this.ethUsd
          },
          {
            type: "area",
            name: "BTC to USD",
            data: this.btcUsd
          },
          {
            type: "area",
            name: "BTC to EUR",
            data: this.btcEur
          }
        ]
      });
    }
  }
};

window.testChartData = [
  [1480636800000, 0.9398],
  [1480896000000, 0.9345],
  [1480982400000, 0.9317],
  [1481068800000, 0.9321],
  [1481155200000, 0.9293],
  [1481241600000, 0.9472],
  [1481500800000, 0.9439],
  [1481587200000, 0.9426],
  [1481673600000, 0.9396],
  [1481760000000, 0.9599],
  [1481846400000, 0.958],
  [1482105600000, 0.9596],
  [1482192000000, 0.965],
  [1482278400000, 0.9597],
  [1482364800000, 0.9576],
  [1482451200000, 0.9574],
  [1482796800000, 0.9575],
  [1482883200000, 0.9615],
  [1482969600000, 0.9568],
  [1483056000000, 0.9488],
  [1483315200000, 0.9557],
  [1483401600000, 0.963],
  [1483488000000, 0.9582],
  [1483574400000, 0.9524],
  [1483660800000, 0.9445],
  [1483920000000, 0.951],
  [1484006400000, 0.9464],
  [1484092800000, 0.9522],
  [1484179200000, 0.9365],
  [1484265600000, 0.9381],
  [1484524800000, 0.944],
  [1484611200000, 0.9361],
  [1484697600000, 0.9378],
  [1484784000000, 0.9375],
  [1484870400000, 0.9407],
  [1485129600000, 0.9334],
  [1485216000000, 0.9305],
  [1485302400000, 0.9309],
  [1485388800000, 0.9347],
  [1485475200000, 0.9363],
  [1485734400000, 0.9408],
  [1485820800000, 0.9299],
  [1485907200000, 0.9269],
  [1485993600000, 0.9253],
  [1486080000000, 0.9311],
  [1486339200000, 0.9336],
  [1486425600000, 0.9369],
  [1486512000000, 0.9377],
  [1486598400000, 0.9354],
  [1486684800000, 0.9409],
  [1486944000000, 0.9409],
  [1487030400000, 0.9415],
  [1487116800000, 0.9475],
  [1487203200000, 0.9389],
  [1487289600000, 0.9391],
  [1487548800000, 0.9421],
  [1487635200000, 0.9491],
  [1487721600000, 0.9513],
  [1487808000000, 0.9459],
  [1487894400000, 0.9427],
  [1488153600000, 0.9447],
  [1488240000000, 0.9438],
  [1488326400000, 0.9495],
  [1488412800000, 0.9512],
  [1488499200000, 0.9466],
  [1488758400000, 0.9442],
  [1488844800000, 0.9456],
  [1488931200000, 0.9474],
  [1489017600000, 0.9479],
  [1489104000000, 0.943],
  [1489363200000, 0.9379],
  [1489449600000, 0.9407],
  [1489536000000, 0.9415],
  [1489622400000, 0.9324],
  [1489708800000, 0.9315],
  [1489968000000, 0.9302],
  [1490054400000, 0.9259],
  [1490140800000, 0.9254],
  [1490227200000, 0.9272],
  [1490313600000, 0.9256],
  [1490572800000, 0.9185],
  [1490659200000, 0.921],
  [1490745600000, 0.9305],
  [1490832000000, 0.9315],
  [1490918400000, 0.9355],
  [1491177600000, 0.9381],
  [1491264000000, 0.939],
  [1491350400000, 0.9366],
  [1491436800000, 0.9377],
  [1491523200000, 0.9408],
  [1491782400000, 0.9455],
  [1491868800000, 0.9421],
  [1491955200000, 0.9431],
  [1492041600000, 0.9408],
  [1492473600000, 0.9363],
  [1492560000000, 0.9325],
  [1492646400000, 0.9308],
  [1492732800000, 0.9349],
  [1492992000000, 0.9219],
  [1493078400000, 0.9183],
  [1493164800000, 0.9181],
  [1493251200000, 0.9191],
  [1493337600000, 0.915],
  [1493683200000, 0.9163],
  [1493769600000, 0.9159],
  [1493856000000, 0.9153],
  [1493942400000, 0.9124],
  [1494201600000, 0.9143],
  [1494288000000, 0.9185],
  [1494374400000, 0.919],
  [1494460800000, 0.9209],
  [1494547200000, 0.9196],
  [1494806400000, 0.9115],
  [1494892800000, 0.9043],
  [1494979200000, 0.8996],
  [1495065600000, 0.8987],
  [1495152000000, 0.8946],
  [1495411200000, 0.8895],
  [1495497600000, 0.8918],
  [1495584000000, 0.8935],
  [1495670400000, 0.8918],
  [1495756800000, 0.8933],
  [1496016000000, 0.8939],
  [1496102400000, 0.8951],
  [1496188800000, 0.8913],
  [1496275200000, 0.8914],
  [1496361600000, 0.8916],
  [1496620800000, 0.8891],
  [1496707200000, 0.8884],
  [1496793600000, 0.8916],
  [1496880000000, 0.8907],
  [1496966400000, 0.8949],
  [1497225600000, 0.8913],
  [1497312000000, 0.8916],
  [1497398400000, 0.8927],
  [1497484800000, 0.8957],
  [1497571200000, 0.8956],
  [1497830400000, 0.893],
  [1497916800000, 0.8965],
  [1498003200000, 0.8972],
  [1498089600000, 0.8954],
  [1498176000000, 0.8951],
  [1498435200000, 0.894],
  [1498521600000, 0.8868],
  [1498608000000, 0.8792],
  [1498694400000, 0.8763],
  [1498780800000, 0.8764],
  [1499040000000, 0.8797],
  [1499126400000, 0.8809],
  [1499212800000, 0.8828],
  [1499299200000, 0.8784],
  [1499385600000, 0.8764],
  [1499644800000, 0.8783],
  [1499731200000, 0.8769],
  [1499817600000, 0.8735],
  [1499904000000, 0.876],
  [1499990400000, 0.8761],
  [1500249600000, 0.8725],
  [1500336000000, 0.8655],
  [1500422400000, 0.8672],
  [1500508800000, 0.8708],
  [1500595200000, 0.8591],
  [1500854400000, 0.8586],
  [1500940800000, 0.8552],
  [1501027200000, 0.8589],
  [1501113600000, 0.8552],
  [1501200000000, 0.8527],
  [1501459200000, 0.8528],
  [1501545600000, 0.8467],
  [1501632000000, 0.8455],
  [1501718400000, 0.8433],
  [1501804800000, 0.8427],
  [1502064000000, 0.8478],
  [1502150400000, 0.8466],
  [1502236800000, 0.8525],
  [1502323200000, 0.8525],
  [1502409600000, 0.8501],
  [1502668800000, 0.8478],
  [1502755200000, 0.8516],
  [1502841600000, 0.8541],
  [1502928000000, 0.855],
  [1503014400000, 0.8519],
  [1503273600000, 0.8504],
  [1503360000000, 0.8496],
  [1503446400000, 0.8476],
  [1503532800000, 0.8471],
  [1503619200000, 0.847],
  [1503878400000, 0.8387],
  [1503964800000, 0.8301],
  [1504051200000, 0.8393],
  [1504137600000, 0.8458],
  [1504224000000, 0.839],
  [1504483200000, 0.8401],
  [1504569600000, 0.8411],
  [1504656000000, 0.8383],
  [1504742400000, 0.8355],
  [1504828800000, 0.8293],
  [1505088000000, 0.8336],
  [1505174400000, 0.8381],
  [1505260800000, 0.8349],
  [1505347200000, 0.8415],
  [1505433600000, 0.836],
  [1505692800000, 0.8371],
  [1505779200000, 0.8354],
  [1505865600000, 0.8329],
  [1505952000000, 0.8401],
  [1506038400000, 0.8362],
  [1506297600000, 0.8428],
  [1506384000000, 0.8485],
  [1506470400000, 0.8518],
  [1506556800000, 0.8491],
  [1506643200000, 0.8471],
  [1506902400000, 0.8516],
  [1506988800000, 0.8509],
  [1507075200000, 0.8485],
  [1507161600000, 0.8517],
  [1507248000000, 0.8543],
  [1507507200000, 0.8515],
  [1507593600000, 0.8478],
  [1507680000000, 0.8454],
  [1507766400000, 0.8436],
  [1507852800000, 0.8468],
  [1508112000000, 0.8473],
  [1508198400000, 0.8505],
  [1508284800000, 0.8512],
  [1508371200000, 0.8451],
  [1508457600000, 0.8463],
  [1508716800000, 0.8519],
  [1508803200000, 0.8504],
  [1508889600000, 0.8486],
  [1508976000000, 0.8509],
  [1509062400000, 0.8618],
  [1509321600000, 0.8613],
  [1509408000000, 0.8594],
  [1509494400000, 0.8613],
  [1509580800000, 0.8588],
  [1509667200000, 0.858],
  [1509926400000, 0.8629],
  [1510012800000, 0.865],
  [1510099200000, 0.8629],
  [1510185600000, 0.8599],
  [1510272000000, 0.8582],
  [1510531200000, 0.858],
  [1510617600000, 0.8515],
  [1510704000000, 0.8447],
  [1510790400000, 0.8496],
  [1510876800000, 0.8479],
  [1511136000000, 0.8489],
  [1511222400000, 0.8535],
  [1511308800000, 0.8512],
  [1511395200000, 0.8441],
  [1511481600000, 0.8421],
  [1511740800000, 0.8368],
  [1511827200000, 0.8413],
  [1511913600000, 0.8456],
  [1512000000000, 0.8441],
  [1512086400000, 0.8415],
  [1512345600000, 0.8429],
  [1512432000000, 0.8442],
  [1512518400000, 0.8463],
  [1512604800000, 0.8486],
  [1512691200000, 0.8517],
  [1512950400000, 0.8478],
  [1513036800000, 0.85],
  [1513123200000, 0.8522],
  [1513209600000, 0.8443],
  [1513296000000, 0.8471],
  [1513555200000, 0.8479],
  [1513641600000, 0.8459],
  [1513728000000, 0.8443],
  [1513814400000, 0.8433],
  [1513900800000, 0.8438],
  [1514332800000, 0.8408],
  [1514419200000, 0.838],
  [1514505600000, 0.8339]
];
</script>

<style>
#app {
  font-family: Avenir, Helvetica, Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-align: center;
  color: #2c3e50;
  margin-top: 60px;
}

.highcharts-figure,
.highcharts-data-table table {
  min-width: 360px;
  max-width: 800px;
  margin: 1em auto;
}

.highcharts-data-table table {
  font-family: Verdana, sans-serif;
  border-collapse: collapse;
  border: 1px solid #ebebeb;
  margin: 10px auto;
  text-align: center;
  width: 100%;
  max-width: 500px;
}
.highcharts-data-table caption {
  padding: 1em 0;
  font-size: 1.2em;
  color: #555;
}
.highcharts-data-table th {
  font-weight: 600;
  padding: 0.5em;
}
.highcharts-data-table td,
.highcharts-data-table th,
.highcharts-data-table caption {
  padding: 0.5em;
}
.highcharts-data-table thead tr,
.highcharts-data-table tr:nth-child(even) {
  background: #f8f8f8;
}
.highcharts-data-table tr:hover {
  background: #f1f7ff;
}

#wrapper {
  display: inline-flex;
  justify-content: space-between;
}

#chart {
  height: 400px;
  min-width: 1000px;
}
</style>
